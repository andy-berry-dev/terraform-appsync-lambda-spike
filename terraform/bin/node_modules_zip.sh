#!/bin/bash -e

ARGS=$(cat -)
CWD=$(pwd)
NODE_MODULES_SRC=$CWD/$(echo $ARGS | jq -r ".node_modules_src")
BUILD_DIR=$CWD/$(echo $ARGS | jq -r ".build_dir")
ZIPFILE_PATH=$CWD/$(echo $ARGS | jq -r ".zipfile_path")

rm -rf $ZIPFILE_PATH
rm -rf $BUILD_DIR/nodejs

cd $BUILD_DIR
mkdir nodejs
cp -RL $NODE_MODULES_SRC $BUILD_DIR/nodejs/node_modules

zip -rqX $ZIPFILE_PATH nodejs -x \*.log

rm -rf $BUILD_DIR/nodejs

ZIPFILE_HASH=$(cat $ZIPFILE_PATH | openssl dgst -binary -sha256 | base64)

jq -ncM \
  '{ "zipfile_path": $zipfile_path, "zipfile_hash": $zipfile_hash }' \
  --arg zipfile_path "$ZIPFILE_PATH" \
  --arg zipfile_hash "$ZIPFILE_HASH"